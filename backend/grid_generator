from sqlalchemy import func
from sqlalchemy.orm import Session
from .database import SystemSessionLocal, SystemEngine, SystemBase
from .models import WeatherData, GridAnalysis
import time

def generate_grid_analysis():
    """
    WeatherData tablosundaki ham verileri analiz eder ve 
    harita renklendirmesi iÃ§in GridAnalysis tablosuna Ã¶zet rapor yazar.
    """
    # TablolarÄ± garantile
    SystemBase.metadata.create_all(bind=SystemEngine)
    
    db = SystemSessionLocal()
    print("--- Grid Analiz Motoru BaÅŸlatÄ±lÄ±yor ---")
    
    # 1. Mevcut Analizleri Temizle (Yeniden oluÅŸturuyoruz)
    db.query(GridAnalysis).delete()
    db.commit()
    print("Eski harita verileri temizlendi.")

    # 2. TÃ¼m benzersiz koordinatlarÄ± bul
    locations = db.query(
        WeatherData.latitude, 
        WeatherData.longitude
    ).group_by(WeatherData.latitude, WeatherData.longitude).all()
    
    print(f"Toplam {len(locations)} farklÄ± lokasyon analiz edilecek...")
    
    grid_objects = []
    
    for idx, (lat, lon) in enumerate(locations):
        # --- Ä°statistikleri Ã‡ek ---
        stats = db.query(
            func.avg(WeatherData.shortwave_radiation_sum).label("avg_rad"), # MJ/m2
            func.avg(models.WeatherData.wind_speed_mean).label("avg_wind")  # m/s
        ).filter(
            WeatherData.latitude == lat,
            WeatherData.longitude == lon
        ).first()
        
        if not stats: continue

        # --- GÃœNEÅž ANALÄ°ZÄ° (Solar Grid) ---
        # MJ -> kWh (1 kWh = 3.6 MJ)
        avg_rad_kwh = (stats.avg_rad / 3.6) if stats.avg_rad else 0
        
        # Skorlama (0-100 arasÄ±): TÃ¼rkiye'de ortalama 3.8 - 5.5 kWh arasÄ±dÄ±r.
        # 3.0 altÄ± = 0 puan, 6.0 Ã¼stÃ¼ = 100 puan diyelim.
        solar_score = min(100, max(0, (avg_rad_kwh - 3.0) / (6.0 - 3.0) * 100))
        
        solar_grid = GridAnalysis(
            latitude=lat,
            longitude=lon,
            type="Solar",
            annual_potential_kwh_m2=avg_rad_kwh * 365,
            avg_wind_speed_ms=stats.avg_wind,
            overall_score=round(solar_score, 1),
            logistics_score=1.0 # Åžimdilik sabit
        )
        grid_objects.append(solar_grid)

        # --- RÃœZGAR ANALÄ°ZÄ° (Wind Grid) ---
        avg_wind = stats.avg_wind if stats.avg_wind else 0
        
        # Skorlama: 3 m/s altÄ± Ã§Ã¶p, 9 m/s Ã¼stÃ¼ harika.
        wind_score = min(100, max(0, (avg_wind - 3.0) / (9.0 - 3.0) * 100))
        
        wind_grid = GridAnalysis(
            latitude=lat,
            longitude=lon,
            type="Wind",
            annual_potential_kwh_m2=0, # RÃ¼zgar iÃ§in bu alan boÅŸ kalabilir
            avg_wind_speed_ms=avg_wind,
            overall_score=round(wind_score, 1),
            logistics_score=1.0
        )
        grid_objects.append(wind_grid)
        
        if idx % 50 == 0:
            print(f"Ä°ÅŸlenen: {idx}/{len(locations)}")

    # Toplu KayÄ±t
    db.bulk_save_objects(grid_objects)
    db.commit()
    db.close()
    
    print(f"ðŸŽ‰ Analiz TamamlandÄ±! {len(grid_objects)} adet grid hÃ¼cresi oluÅŸturuldu.")
    print("Flutter haritasÄ± artÄ±k bu verileri kullanabilir.")

if __name__ == "__main__":
    from . import models # Modelleri yÃ¼klemek iÃ§in
    generate_grid_analysis()